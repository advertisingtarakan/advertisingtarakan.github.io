<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Uploader Dokumentasi ‚Üí GitHub</title>

<style>
:root{
  --bg:#0b1220; --fg:#e8eeff; --muted:#9fb0d0; --line:#233;
}
*{box-sizing:border-box}
body{
  margin:0; padding:24px;
  background:var(--bg); color:var(--fg);
  font-family:system-ui
}
.container{max-width:1100px;margin:auto}
.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
  background:#0f172a;
  margin-bottom:16px
}
h1{margin:0 0 6px;font-size:20px}
p{margin:0;color:var(--muted);font-size:13px}

.drop{
  border:2px dashed #334;
  border-radius:16px;
  padding:20px;
  min-height:220px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:10px;
  cursor:pointer;
  text-align:center
}
.drop.dragover{background:#13203a}

input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#0b1220;
  color:var(--fg)
}
button{cursor:pointer;font-weight:700}
button:disabled{opacity:.5}

.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{
  display:grid;
  grid-template-columns:80px 1fr auto;
  gap:10px;
  align-items:center;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px
}
.thumb{width:80px;height:60px;object-fit:cover;border-radius:8px}

pre{
  background:#050913;
  padding:10px;
  border-radius:10px;
  max-height:220px;
  overflow:auto;
  font-size:12px
}
</style>
</head>

<body>
<div class="container">

<div class="card">
<h1>Uploader Dokumentasi</h1>
<p>Drag & drop, paste <b>Ctrl + V</b>, atau pilih file ‚Üí upload langsung ke GitHub</p>
</div>

<div class="card">
<label>GitHub Token (Classic)</label>
<input id="token" type="password" placeholder="ghp_..." />
</div>

<div class="card drop" id="drop">
  üñºÔ∏è Drop / Paste gambar di sini
  <input id="filePicker" type="file" accept="image/*" multiple hidden>
  <button id="btnPick">üìÅ Pilih File</button>
</div>

<div class="card">
<label>Kategori</label>
<select id="category"></select>

<label>Judul / Nama Pekerjaan</label>
<input id="title" placeholder="Contoh: RS UKT">

<button id="uploadBtn" disabled>üöÄ Upload ke GitHub</button>
</div>

<div class="card">
<div id="fileList" class="list"></div>
</div>

<div class="card">
<pre id="log"></pre>
</div>

</div>

<script>
/* ================= HELPERS ================= */
const $ = (id) => document.getElementById(id);

const state = {
  files: []
};

function log(msg){
  const el = $("log");
  const t = new Date().toLocaleString("id-ID");
  el.textContent += `[${t}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
}

function pad2(n){ return String(n).padStart(2,"0"); }

function today(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function slug(s){
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[^\w\s-]/g,"")   // buang simbol
    .replace(/\s+/g,"-")       // spasi -> -
    .replace(/-+/g,"-");       // rapihin ----
}

function b64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onerror = () => reject(new Error("Gagal baca file"));
    r.onload = () => {
      // r.result = "data:image/png;base64,...."
      resolve(String(r.result).split(",")[1]);
    };
    r.readAsDataURL(file);
  });
}

/* ================= CONFIG ================= */
const GITHUB = {
  owner: "advertisingtarakan",
  repo: "advertisingtarakan.github.io",
  branch: "main"
};

/* ================= CONFIG FILES ================= */
// pakai absolute path supaya aman di GitHub Pages root
const CONFIG_URL = "/gallery-config.json";

/* ================= INIT CONFIG ================= */
async function loadConfig(){
  const res = await fetch(CONFIG_URL, { cache: "no-store" });
  const text = await res.text();

  if(!res.ok){
    throw new Error(`HTTP ${res.status} saat load config. Awal respons: ${text.slice(0,120)}`);
  }

  try{
    return JSON.parse(text);
  }catch(e){
    throw new Error(`Config bukan JSON valid. Awal respons: ${text.slice(0,120)}`);
  }
}

async function initCategories(){
  const sel = $("category");
  sel.innerHTML = `<option value="">-- pilih kategori --</option>`;

  const cfg = await loadConfig();
  const categories = Array.isArray(cfg.categories) ? cfg.categories : [];

  categories.forEach(c=>{
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c.replace(/-/g," ").toUpperCase();
    sel.appendChild(o);
  });

  log(`‚úÖ Config loaded. Total kategori: ${categories.length}`);
}

initCategories().catch(err=>{
  console.error(err);
  log("‚ùå " + err.message);
  alert("Config kategori tidak bisa dibaca. Pastikan gallery-config.json ada.");
});

/* ================= GITHUB API ================= */
async function ghPut(path, body){
  const token = $("token").value.trim();
  const res = await fetch(
    `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${path}`,
    {
      method: "PUT",
      headers: {
        "Authorization": `token ${token}`,
        "Content-Type": "application/json",
        "Accept": "application/vnd.github+json"
      },
      body: JSON.stringify(body)
    }
  );

  const text = await res.text();
  if(!res.ok){
    // GitHub biasanya mengembalikan JSON error, tapi kadang text juga
    throw new Error(`GitHub PUT gagal (${res.status}): ${text.slice(0,200)}`);
  }

  try { return JSON.parse(text); }
  catch { return text; }
}

async function ghGet(path){
  const token = $("token").value.trim();
  const res = await fetch(
    `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${path}`,
    {
      headers: {
        "Authorization": `token ${token}`,
        "Accept": "application/vnd.github+json"
      }
    }
  );

  if(!res.ok) return null;
  return res.json();
}

/* ================= FILE HANDLING ================= */
function addFiles(files){
  [...files].forEach(f=>{
    if(f && f.type && f.type.startsWith("image/")) state.files.push(f);
  });
  render();
}

function render(){
  const list = $("fileList");
  list.innerHTML = "";

  state.files.forEach((f,i)=>{
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <img class="thumb" src="${URL.createObjectURL(f)}" alt="">
      <div>${f.name}</div>
      <button type="button" onclick="removeFile(${i})">üóëÔ∏è</button>
    `;
    list.appendChild(d);
  });

  validate();
}

function removeFile(i){
  state.files.splice(i,1);
  render();
}

function validate(){
  $("uploadBtn").disabled = !(
    state.files.length &&
    $("category").value &&
    $("title").value.trim() &&
    $("token").value.trim()
  );
}

/* ================= EVENTS ================= */
$("btnPick").onclick = ()=> $("filePicker").click();
$("filePicker").onchange = e => addFiles(e.target.files);

["dragover","dragenter"].forEach(evt=>{
  $("drop").addEventListener(evt, ev=>{
    ev.preventDefault();
    $("drop").classList.add("dragover");
  });
});
["dragleave","drop"].forEach(evt=>{
  $("drop").addEventListener(evt, ev=>{
    ev.preventDefault();
    $("drop").classList.remove("dragover");
  });
});
$("drop").addEventListener("drop", e => addFiles(e.dataTransfer.files));

window.addEventListener("paste", e=>{
  const imgs = [...e.clipboardData.items]
    .filter(i=>i.type && i.type.startsWith("image/"))
    .map(i=>i.getAsFile());
  addFiles(imgs);
});

$("category").onchange =
$("title").oninput =
$("token").oninput = validate;

/* ================= UPLOAD + MANIFEST ================= */
$("uploadBtn").onclick = async ()=>{
  try{
    log("Mulai upload...");

    const cat = $("category").value;
    const title = $("title").value.trim();
    const date = today();

    // load manifest lama jika ada
    let manifest = { items: [] };
    let manifestSha = null;

    const mf = await ghGet("gallery-manifest.json");
    if(mf && mf.content){
      manifestSha = mf.sha;
      manifest = JSON.parse(atob(mf.content));
      if(!manifest.items) manifest.items = [];
    }

    let i = 0;
    for(const f of state.files){
      const ext = (f.name.split(".").pop() || "png").toLowerCase();
      const filename = `${date}__${slug(title)}__${Date.now()+i}.${ext}`;
      const path = `${cat}/${filename}`;

      log("Upload: " + path);

      await ghPut(path, {
        message: "upload via updoc",
        content: await b64(f),
        branch: GITHUB.branch
      });

      manifest.items.push({
        category: cat,
        title: title,
        date: date,
        file: path
      });

      i++;
    }

    await ghPut("gallery-manifest.json", {
      message: "update gallery manifest",
      content: btoa(JSON.stringify(manifest, null, 2)),
      sha: manifestSha,
      branch: GITHUB.branch
    });

    log("‚úÖ Upload + manifest update selesai");
    alert("Upload & manifest berhasil");

    state.files = [];
    render();
  }catch(err){
    console.error(err);
    log("‚ùå " + (err.message || String(err)));
    alert("Gagal upload. Cek Console & log untuk detail error.");
  }
};
</script>

</body>
</html>



<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Uploader Dokumentasi ‚Üí GitHub</title>

<style>
:root{
  --bg:#0b1220; --fg:#e8eeff; --muted:#9fb0d0; --line:#233;
}
*{box-sizing:border-box}
body{
  margin:0; padding:24px;
  background:var(--bg); color:var(--fg);
  font-family:system-ui
}
.container{max-width:1100px;margin:auto}
.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
  background:#0f172a;
  margin-bottom:16px
}
h1{margin:0 0 6px;font-size:20px}
p{margin:0;color:var(--muted);font-size:13px}

.drop{
  border:2px dashed #334;
  border-radius:16px;
  padding:20px;
  min-height:220px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:10px;
  cursor:pointer;
  text-align:center
}
.drop.dragover{background:#13203a}

input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#0b1220;
  color:var(--fg)
}
button{cursor:pointer;font-weight:700}
button:disabled{opacity:.5}

.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{
  display:grid;
  grid-template-columns:80px 1fr auto;
  gap:10px;
  align-items:center;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px
}
.thumb{width:80px;height:60px;object-fit:cover;border-radius:8px}

pre{
  background:#050913;
  padding:10px;
  border-radius:10px;
  max-height:220px;
  overflow:auto;
  font-size:12px
}
</style>
</head>

<body>
<div class="container">

<div class="card">
<h1>Uploader Dokumentasi</h1>
<p>Drag & drop, paste <b>Ctrl + V</b>, atau pilih file ‚Üí upload langsung ke GitHub</p>
</div>

<div class="card">
<label>GitHub Token (Classic)</label>
<input id="token" type="password" placeholder="ghp_..." />
</div>

<div class="card drop" id="drop">
  üñºÔ∏è Drop / Paste gambar di sini
  <input id="filePicker" type="file" accept="image/*" multiple hidden>
  <button id="btnPick">üìÅ Pilih File</button>
</div>

<div class="card">
<label>Kategori</label>
<select id="category"></select>

<label>Judul / Nama Pekerjaan</label>
<input id="title" placeholder="Contoh: RS UKT">

<button id="uploadBtn" disabled>üöÄ Upload ke GitHub</button>
</div>

<div class="card">
<div id="fileList" class="list"></div>
</div>

<div class="card">
<pre id="log"></pre>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const GITHUB = {
  owner: "advertisingtarakan",
  repo: "advertisingtarakan.github.io",
  branch: "main"
};

/* ================= KATEGORI ================= */
const CATEGORIES = [
  "neonbox",
  "huruf-timbul",
  "plang",
  "spanduk",
  "banner",
  "stiker",
  "cutting-sticker",
  "akrilik",
  "backdrop",
  "billboard",
  "signage",
  "papan-nama",
  "display",
  "letter-sign",
  "kaca-film",
  "jasa-pasang-sticker",
  "lainnya"
];

/* ================= STATE ================= */
const state = { files: [] };

/* ================= UTIL ================= */
const $ = id => document.getElementById(id);
const log = m => $("log").textContent += m + "\n";
const today = () => new Date().toISOString().slice(0,10);
const slug = s => s.toLowerCase().trim().replace(/[^a-z0-9]+/g,"-");
const b64 = f => new Promise(r=>{
  const fr=new FileReader();
  fr.onload=()=>r(fr.result.split(",")[1]);
  fr.readAsDataURL(f);
});

/* ================= INIT ================= */
(function initCategories(){
  const sel = $("category");
  sel.innerHTML = `<option value="">-- pilih kategori --</option>`;
  CATEGORIES.forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    o.textContent=c.replace(/-/g," ").toUpperCase();
    sel.appendChild(o);
  });
})();

/* ================= GITHUB API ================= */
async function ghPut(path, body){
  const token = $("token").value.trim();
  const res = await fetch(
    `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${path}`,
    {
      method:"PUT",
      headers:{
        "Authorization":`token ${token}`,
        "Content-Type":"application/json"
      },
      body:JSON.stringify(body)
    }
  );
  if(!res.ok) throw await res.text();
  return res.json();
}

async function ghGet(path){
  const token = $("token").value.trim();
  const res = await fetch(
    `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${path}`,
    { headers:{ Authorization:`token ${token}` } }
  );
  if(!res.ok) return null;
  return res.json();
}

/* ================= FILE HANDLING ================= */
function addFiles(files){
  [...files].forEach(f=>{
    if(f.type.startsWith("image/")) state.files.push(f);
  });
  render();
}

function render(){
  const list=$("fileList");
  list.innerHTML="";
  state.files.forEach((f,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <img class="thumb" src="${URL.createObjectURL(f)}">
      <div>${f.name}</div>
      <button onclick="removeFile(${i})">üóëÔ∏è</button>`;
    list.appendChild(d);
  });
  validate();
}

function removeFile(i){
  state.files.splice(i,1);
  render();
}

function validate(){
  $("uploadBtn").disabled = !(
    state.files.length &&
    $("category").value &&
    $("title").value.trim() &&
    $("token").value.trim()
  );
}

/* ================= EVENTS ================= */
$("btnPick").onclick=()=> $("filePicker").click();
$("filePicker").onchange=e=>addFiles(e.target.files);

["dragover","dragenter"].forEach(e=>{
  $("drop").addEventListener(e,ev=>{
    ev.preventDefault();
    $("drop").classList.add("dragover");
  });
});
["dragleave","drop"].forEach(e=>{
  $("drop").addEventListener(e,ev=>{
    ev.preventDefault();
    $("drop").classList.remove("dragover");
  });
});
$("drop").addEventListener("drop",e=>addFiles(e.dataTransfer.files));

window.addEventListener("paste",e=>{
  const imgs=[...e.clipboardData.items]
    .filter(i=>i.type.startsWith("image/"))
    .map(i=>i.getAsFile());
  addFiles(imgs);
});

$("category").onchange =
$("title").oninput =
$("token").oninput = validate;

/* ================= UPLOAD + MANIFEST ================= */
$("uploadBtn").onclick = async ()=>{
  log("Mulai upload...");

  const cat = $("category").value;
  const title = $("title").value;
  const date = today();

  let manifest = { items: [] };
  let manifestSha = null;

  const mf = await ghGet("gallery-manifest.json");
  if(mf){
    manifestSha = mf.sha;
    manifest = JSON.parse(atob(mf.content));
  }

  let i=0;
  for(const f of state.files){
    const ext = f.name.split(".").pop();
    const filename =
      `${date}__${slug(title)}__${Date.now()+i}.${ext}`;
    const path = `${cat}/${filename}`;

    log("Upload: "+path);

    await ghPut(path,{
      message:"upload via updoc",
      content: await b64(f),
      branch:GITHUB.branch
    });

    // üëâ STRUKTUR SESUAI MANIFEST ASLI
    manifest.items.push({
      category: cat,
      title: title,
      date: date,
      file: path
    });

    i++;
  }

  await ghPut("gallery-manifest.json",{
    message:"update gallery manifest",
    content: btoa(JSON.stringify(manifest, null, 2)),
    sha: manifestSha,
    branch:GITHUB.branch
  });

  log("‚úÖ Upload + manifest update selesai");
  alert("Upload & manifest berhasil");

  state.files=[];
  render();
};
</script>
</body>
</html>

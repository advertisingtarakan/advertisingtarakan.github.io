<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Updoc ‚Äî GitHub Direct Uploader</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:system-ui;
  background:#0b1220;
  color:#e8eeff;
  margin:0;
  padding:20px
}
.card{
  max-width:900px;
  margin:auto;
  background:#111a2e;
  padding:20px;
  border-radius:16px
}
label{
  display:block;
  margin-top:10px;
  font-size:13px;
  opacity:.85
}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:10px;
  border:1px solid #333;
  background:#0b1220;
  color:#fff
}
button{
  cursor:pointer;
  font-weight:800;
  margin-top:15px
}
button:disabled{opacity:.5}
.list{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:15px
}
.thumb{
  width:90px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #333
}
pre{
  background:#050913;
  padding:10px;
  border-radius:10px;
  max-height:200px;
  overflow:auto;
  font-size:12px
}
.warn{
  background:#1c243f;
  border-left:4px solid #ffcc66;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
  font-size:12px
}
</style>
</head>

<body>
<div class="card">
<h2>Uploader Dokumentasi ‚Üí GitHub</h2>

<div class="warn">
üîê <b>Admin only</b> ‚Äî Token tidak disimpan.  
Masukkan GitHub Personal Access Token setiap kali upload.
</div>

<label>GitHub Token</label>
<input id="token" type="password" placeholder="ghp_..." />

<label>Kategori</label>
<select id="category">
  <option value="">-- pilih kategori --</option>
  <option value="neonbox">Neonbox</option>
  <option value="plang">Plang</option>
  <option value="huruf-timbul">Huruf Timbul</option>
</select>

<label>Judul</label>
<input id="title" placeholder="Contoh: Pemasangan Neonbox Pelabuhan">

<label>Pilih Gambar</label>
<input id="files" type="file" multiple accept="image/*">

<button id="uploadBtn" disabled>üöÄ Upload ke GitHub</button>

<div class="list" id="list"></div>
<pre id="log"></pre>
</div>

<script>
/* =======================
   KONFIGURASI REPO
======================= */
const GITHUB = {
  owner: "USERNAME_GITHUB",
  repo: "REPO_UPLOAD",
  branch: "main"
};

/* =======================
   ELEMENT
======================= */
const tokenEl = document.getElementById("token");
const filesEl = document.getElementById("files");
const listEl = document.getElementById("list");
const uploadBtn = document.getElementById("uploadBtn");
const logEl = document.getElementById("log");
const catEl = document.getElementById("category");
const titleEl = document.getElementById("title");

let files = [];

/* =======================
   UTIL
======================= */
function log(msg){
  logEl.textContent += msg + "\n";
}
function slugify(s){
  return s.toLowerCase().trim()
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-|-$/g,"");
}
function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function fileToBase64(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

/* =======================
   GITHUB API
======================= */
async function ghPut(path, body){
  const token = tokenEl.value.trim();
  if(!token) throw "Token kosong";

  const r = await fetch(
    `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${path}`,
    {
      method:"PUT",
      headers:{
        "Authorization":`token ${token}`,
        "Content-Type":"application/json"
      },
      body:JSON.stringify(body)
    }
  );
  if(!r.ok) throw await r.text();
  return r.json();
}

async function getManifest(){
  const token = tokenEl.value.trim();
  try{
    const r = await fetch(
      `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/gallery-manifest.json`,
      { headers:{ "Authorization":`token ${token}` } }
    );
    if(!r.ok) return {items:[]};
    const j = await r.json();
    return {
      sha: j.sha,
      data: JSON.parse(atob(j.content))
    };
  }catch{
    return {items:[]};
  }
}

/* =======================
   UI
======================= */
filesEl.onchange = () => {
  files = [...filesEl.files];
  listEl.innerHTML = "";
  files.forEach(f=>{
    const img=document.createElement("img");
    img.src=URL.createObjectURL(f);
    img.className="thumb";
    listEl.appendChild(img);
  });
  validate();
};
catEl.onchange = titleEl.oninput = tokenEl.oninput = validate;

function validate(){
  uploadBtn.disabled = !(
    files.length &&
    catEl.value &&
    titleEl.value.trim() &&
    tokenEl.value.trim()
  );
}

/* =======================
   UPLOAD
======================= */
uploadBtn.onclick = async () => {
  uploadBtn.disabled = true;
  log("Mulai upload...");

  try{
    const date = today();
    const slug = slugify(titleEl.value);
    const cat = catEl.value;

    const manifest = await getManifest();
    const items = manifest.data?.items || [];

    let i = 0;
    for(const f of files){
      const ext = f.name.split(".").pop();
      const name = `${date}__${slug}__${Date.now()+i}.${ext}`;
      const path = `${cat}/${name}`;

      log("Upload: " + path);

      await ghPut(path,{
        message:"upload via updoc",
        content: await fileToBase64(f),
        branch:GITHUB.branch
      });

      items.push({
        category:cat,
        title:titleEl.value,
        date,
        file:path
      });
      i++;
    }

    await ghPut("gallery-manifest.json",{
      message:"update manifest",
      content:btoa(JSON.stringify({items},null,2)),
      sha: manifest.sha,
      branch:GITHUB.branch
    });

    log("‚úÖ SELESAI");
    alert("Upload berhasil!");
    filesEl.value="";
    files=[];
    listEl.innerHTML="";
  }catch(e){
    log("‚ùå ERROR: " + e);
    alert("Upload gagal, cek log");
  }
  validate();
};
</script>
</body>
</html>

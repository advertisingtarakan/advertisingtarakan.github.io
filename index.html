/* index.js
   Gallery display for GitHub Pages (static).
   It scans folder categories (lowercase) and reads an optional manifest:
   - ./gallery-manifest.json  (recommended)
   If manifest not found, it will show an empty state + instructions.

   Expected file structure:
   /neonbox/...
   /plang/...
   /huruf timbul/  <-- (NOT allowed; use huruf-timbul or huruf_timbul?) 
   IMPORTANT: you requested folder name lower-case; to be filesystem-safe on web
   we use:
     neonbox
     plang
     huruf-timbul
     cutting-akrilik
     jasa-pasang-sticker

   Create / update gallery-manifest.json whenever you add images.
*/

(() => {
  const CATEGORIES = [
    { key: "neonbox", label: "Neonbox" },
    { key: "plang", label: "Plang" },
    { key: "huruf-timbul", label: "Huruf Timbul" },
    { key: "cutting-akrilik", label: "Cutting Akrilik" },
    { key: "jasa-pasang-sticker", label: "Jasa Pasang Sticker" },
  ];

  const MANIFEST_URL = "./gallery-manifest.json"; // you keep this in repo root
  const DEFAULT_CATEGORY = "all";

  const $ = (sel) => document.querySelector(sel);

  function el(tag, attrs = {}, children = []) {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, String(v));
    }
    for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    return n;
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  }

  async function fetchJson(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  function normalizeManifestItems(manifest) {
    // Manifest format:
    // {
    //   "items":[
    //     {
    //       "category":"neonbox",
    //       "title":"Judul",
    //       "date":"2026-01-27",
    //       "file":"neonbox/2026-01-27_judul_slug.jpg"
    //     }, ...
    //   ]
    // }
    const items = Array.isArray(manifest?.items) ? manifest.items : [];
    return items
      .map((it) => ({
        category: String(it.category || "").toLowerCase(),
        title: String(it.title || "Tanpa Judul"),
        date: String(it.date || ""),
        file: String(it.file || ""),
      }))
      .filter((it) => it.category && it.file);
  }

  function buildUI() {
    // minimal injection into existing index.html
    // required containers in index.html:
    // #categorySelect, #searchInput, #galleryGrid, #countText, #emptyState, #modal, #modalImg, #modalTitle, #modalMeta, #btnDownload, #btnClose
    const catSel = $("#categorySelect");
    if (catSel) {
      catSel.innerHTML = "";
      catSel.appendChild(el("option", { value: DEFAULT_CATEGORY }, ["Semua Kategori"]));
      for (const c of CATEGORIES) catSel.appendChild(el("option", { value: c.key }, [c.label]));
    }
  }

  function filterItems(items, category, q) {
    const qq = (q || "").trim().toLowerCase();
    return items.filter((it) => {
      if (category && category !== DEFAULT_CATEGORY && it.category !== category) return false;
      if (qq) {
        const hay = `${it.title} ${it.category} ${it.date} ${it.file}`.toLowerCase();
        if (!hay.includes(qq)) return false;
      }
      return true;
    });
  }

  function renderGallery(items) {
    const grid = $("#galleryGrid");
    const count = $("#countText");
    const empty = $("#emptyState");

    if (!grid) return;

    grid.innerHTML = "";

    if (!items.length) {
      if (count) count.textContent = "0 item";
      if (empty) empty.style.display = "block";
      return;
    }

    if (empty) empty.style.display = "none";
    if (count) count.textContent = `${items.length} item`;

    // newest first by date (fallback: file)
    const sorted = items.slice().sort((a, b) => {
      const da = a.date || "";
      const db = b.date || "";
      if (da !== db) return db.localeCompare(da);
      return (b.file || "").localeCompare(a.file || "");
    });

    for (const it of sorted) {
      const card = el("div", { class: "g-card", tabindex: "0" });

      const thumb = el("img", {
        class: "g-thumb",
        src: `./${it.file}`,
        alt: it.title,
        loading: "lazy",
      });

      const meta = el("div", { class: "g-meta" }, [
        el("div", { class: "g-badges" }, [
          el("span", { class: "badge" }, [categoryLabel(it.category)]),
          it.date ? el("span", { class: "badge badge-muted" }, [it.date]) : el("span"),
        ]),
        el("div", { class: "g-title" }, [it.title]),
      ]);

      card.appendChild(thumb);
      card.appendChild(meta);

      card.addEventListener("click", () => openModal(it));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openModal(it);
        }
      });

      grid.appendChild(card);
    }
  }

  function categoryLabel(key) {
    return (CATEGORIES.find((c) => c.key === key)?.label) || key;
  }

  function openModal(item) {
    const modal = $("#modal");
    const img = $("#modalImg");
    const title = $("#modalTitle");
    const meta = $("#modalMeta");
    const btnDl = $("#btnDownload");

    if (!modal || !img) return;

    img.src = `./${item.file}`;
    img.alt = item.title;
    if (title) title.textContent = item.title;
    if (meta) meta.innerHTML = `
      <span class="badge">${escapeHtml(categoryLabel(item.category))}</span>
      ${item.date ? `<span class="badge badge-muted">${escapeHtml(item.date)}</span>` : ""}
    `;

    if (btnDl) {
      btnDl.setAttribute("href", `./${item.file}`);
      btnDl.setAttribute("download", item.file.split("/").pop() || "download");
    }

    modal.classList.add("open");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    const modal = $("#modal");
    if (!modal) return;
    modal.classList.remove("open");
    document.body.style.overflow = "";
  }

  function wireModal() {
    const modal = $("#modal");
    const btnClose = $("#btnClose");

    if (btnClose) btnClose.addEventListener("click", closeModal);

    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });
    }

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });
  }

  async function main() {
    buildUI();
    wireModal();

    const catSel = $("#categorySelect");
    const search = $("#searchInput");

    let allItems = [];
    try {
      const manifest = await fetchJson(MANIFEST_URL);
      allItems = normalizeManifestItems(manifest);

      $("#manifestHint") && ( $("#manifestHint").style.display = "none" );
    } catch (e) {
      // no manifest, show hint
      const hint = $("#manifestHint");
      if (hint) {
        hint.style.display = "block";
        hint.innerHTML = `
          <div class="hint">
            <b>Manifest tidak ditemukan:</b> <code>${MANIFEST_URL}</code><br/>
            Agar gallery bisa tampil otomatis di GitHub Pages (static), buat file <code>gallery-manifest.json</code> berisi daftar gambar.<br/>
            Kamu bisa generate dari <b>updoc.html</b> (akan dibuatkan paket ZIP yang sudah termasuk <code>gallery-manifest.json</code>).
          </div>
        `;
      }
      allItems = [];
    }

    function rerender() {
      const category = catSel ? catSel.value : DEFAULT_CATEGORY;
      const q = search ? search.value : "";
      const filtered = filterItems(allItems, category, q);
      renderGallery(filtered);
    }

    if (catSel) catSel.addEventListener("change", rerender);
    if (search) search.addEventListener("input", () => {
      clearTimeout(window.__qT);
      window.__qT = setTimeout(rerender, 150);
    });

    rerender();
  }

  document.addEventListener("DOMContentLoaded", main);
})();
